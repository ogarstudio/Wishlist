<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>List</title>
<style>
  :root{
    --bg:#f3f4f6;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#374151;
    --header-bg:#d1d5db;
    --shadow: 0 6px 18px rgba(15,23,42,0.06);
    --danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#111827}
  .app{max-width:980px;margin:0 auto;display:flex;flex-direction:column;min-height:100vh}

  /* header (full-bleed) */
  header{
    background:var(--header-bg);
    width:100%;
    display:flex;
    flex-direction:column;
    border-bottom:1px solid rgba(0,0,0,0.06);
    position:sticky;
    top:0;
    z-index:60;
  }
  .header-inner{
    display:flex;align-items:center;justify-content:center;padding:14px 16px;gap:12px;
  }
  .hdr-left{flex:0 0 auto;color:var(--accent);font-weight:600;}
  .hdr-center{flex:1;text-align:center;font-size:20px;font-weight:700;color:var(--accent);}
  .hdr-right{flex:0 0 auto;width:44px}

  /* toggles row */
  .controls-row{background:transparent;padding:10px 16px;border-bottom:1px solid rgba(0,0,0,0.03)}
  .controls-inner{max-width:980px;margin:0 auto;display:flex;align-items:center;gap:12px}
  .toggle{display:flex;align-items:center;gap:8px;background:#fff;border-radius:10px;padding:8px 12px;border:1px solid rgba(0,0,0,0.04);box-shadow:var(--shadow)}
  .toggle input{width:18px;height:18px;cursor:pointer}
  .toggle-label{font-weight:700}

  /* Delete selected bar */
  .delete-bar{max-width:980px;margin:8px auto;padding:8px 16px;display:flex;gap:12px;align-items:center;justify-content:flex-end}
  .delete-selected-btn{background:var(--danger);color:white;border:none;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(239,68,68,0.12)}
  .delete-selected-btn[disabled]{opacity:0.45;cursor:not-allowed}

  main{flex:1;padding:20px 16px 120px}
  .card{background:var(--card);border-radius:12px;box-shadow:var(--shadow);padding:14px}
  .list-grid{display:grid;gap:12px}

  .item{
    display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:10px;border:1px solid rgba(15,23,42,0.04);background:transparent;
  }
  .thumb{width:72px;height:72px;border-radius:8px;overflow:hidden;background:#f8fafc;border:1px solid rgba(0,0,0,0.03);flex:0 0 72px}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .checkbox{width:22px;height:22px;border-radius:6px;border:1.5px solid #9ca3af;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
  .checkbox.checked{border-color:#111827}
  .item-body{flex:1;min-width:0}
  .item-title{font-weight:700;font-size:16px;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .item-meta{font-size:13px;color:var(--muted)}
  .item-right{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  .icon-btn{background:transparent;border:none;padding:8px;border-radius:8px;cursor:pointer}
  .delete-btn svg{stroke:var(--danger)}
  .link-badge{font-size:13px;padding:6px 8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);text-decoration:none;color:var(--accent);display:inline-flex;gap:6px;align-items:center}

  /* Add form */
  .form-row{display:flex;flex-direction:column;gap:10px}
  input[type=text],input[type=number],textarea{padding:12px;border-radius:10px;border:1px solid rgba(15,23,42,0.08);font-size:15px;outline:none;background:white;width:100%}
  textarea{min-height:120px}
  .button{background:#111827;color:white;border:none;padding:12px 18px;border-radius:12px;font-weight:700;cursor:pointer}

  /* bottom nav */
  nav.bottom-nav{position:fixed;left:0;right:0;bottom:0;background:#000;display:flex;justify-content:center;padding:8px 0;border-top:1px solid rgba(255,255,255,0.04);z-index:70}
  .nav-inner{width:100%;max-width:980px;display:flex;justify-content:space-around;align-items:center;padding:6px 12px}
  .nav-btn{background:transparent;border:none;color:#9ca3af;display:flex;flex-direction:column;align-items:center;font-size:12px;gap:6px;padding:6px 8px;cursor:pointer}
  .nav-btn.active{color:var(--danger)}
  .nav-btn svg{width:28px;height:28px;stroke:currentColor;fill:none;stroke-width:2}
  .muted{color:var(--muted);font-size:13px}

  /* categories UI */
  .category{margin-bottom:12px;border:1px solid rgba(0,0,0,0.06);border-radius:10px;overflow:hidden;background:#fff}
  .category-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;font-weight:700;background:#f9fafb;cursor:pointer}
  .category-items{padding:10px 14px;display:grid;gap:10px}
  .cat-arrow{margin-right:8px;transition:transform .2s}
  .category.collapsed .cat-arrow{transform:rotate(-90deg);}
  .category .item-drop-target{min-height:30px;padding:6px;border-radius:8px;border:1px dashed rgba(0,0,0,0.06)}
  @media (min-width:720px){main{padding:22px 28px 140px}}
</style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="hdr-left" id="headerBudget">Budget: £0.00</div>
      <div class="hdr-center">List</div>
      <div class="hdr-right"></div>
    </div>

    <div class="controls-row">
      <div class="controls-inner" id="controlsInner">
        <div class="toggle" title="Show or hide item images">
          <input type="checkbox" id="showImagesToggle" />
          <label for="showImagesToggle" class="toggle-label">Show Images</label>
        </div>

        <div class="toggle" title="Turn on to select items for deletion">
          <input type="checkbox" id="deleteModeToggle" />
          <label for="deleteModeToggle" class="toggle-label">Delete Mode</label>
        </div>

        <div style="margin-left:8px" class="muted">Images are saved locally in your browser</div>
      </div>
    </div>

    <div id="deleteBar" class="delete-bar" style="display:none">
      <div style="flex:1"></div>
      <button id="deleteSelectedBtn" class="delete-selected-btn" disabled>Delete Selected</button>
    </div>
  </header>

  <main>
    <div class="app" id="appRoot" role="application" aria-label="List app">
      <!-- LIST -->
      <section id="screen-list" class="screen">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <div>
              <div style="font-weight:700;font-size:14px">Your items</div>
              <div class="muted" id="itemsSummary">0 items • 0 bought</div>
            </div>
            <div class="muted">Total spent: £<span id="totalSpent">0.00</span></div>
          </div>

          <div id="categoryContainer"></div>

          <div id="uncatContainer" style="margin-top:14px">
            <div style="font-weight:700;margin-bottom:8px">Uncategorized</div>
            <div id="uncatItems" class="list-grid"></div>
          </div>

          <div id="emptyMsg" style="text-align:center;padding:28px;color:var(--muted);display:none">Your list is empty — add something on the Add tab.</div>
        </div>
      </section>

      <!-- BUDGET -->
      <section id="screen-budget" class="screen" style="display:none">
        <div class="card">
          <h3 style="margin-top:0;margin-bottom:8px">Budget</h3>
          <p class="muted" style="margin-top:0;margin-bottom:12px">Set your total budget (displayed in the header).</p>
          <div style="display:flex;gap:10px;align-items:flex-end">
            <div style="display:flex;flex-direction:column;">
              <label for="budgetInput">Enter total budget</label>
              <input id="budgetInput" type="number" step="0.01" min="0" placeholder="0.00" />
            </div>
            <div style="margin-left:auto">
              <button id="saveBudgetBtn" class="button">Save Changes</button>
            </div>
          </div>
        </div>
      </section>

      <!-- ADD -->
      <section id="screen-add" class="screen" style="display:none">
        <div class="card">
          <h3 style="margin-top:0;margin-bottom:6px">Add to list</h3>
          <p class="muted" style="margin-top:0;margin-bottom:18px">Fill the fields below and tap Add</p>

          <form id="addForm" class="form-row" onsubmit="return false;">
            <div>
              <label for="nameInput">Name</label>
              <input id="nameInput" type="text" placeholder="( Tap to Change )" required />
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <div style="flex:1;min-width:160px">
                <label for="priceInput">Price</label>
                <input id="priceInput" type="number" step="0.01" min="0" placeholder="( Tap to Change )" />
              </div>
              <div style="flex:1;min-width:160px">
                <label for="itemSpent">Spent</label>
                <input id="itemSpent" type="number" step="0.01" min="0" placeholder="( Tap to Change )" />
              </div>
            </div>

            <div>
              <label for="notesInput">Notes</label>
              <textarea id="notesInput" placeholder="Notes..."></textarea>
            </div>

            <div>
              <label for="imageInput">Image (optional)</label>
              <input id="imageInput" type="file" accept="image/*" />
            </div>

            <div>
              <label for="linkInput">Link (optional)</label>
              <input id="linkInput" type="text" placeholder="https://example.com" />
            </div>

            <div>
              <label for="categorySelect">Category (optional)</label>
              <select id="categorySelect">
                <option value="">Uncategorized</option>
              </select>
            </div>

            <div style="display:flex;gap:12px;align-items:center;justify-content:flex-end">
              <button id="addBtn" class="button" type="button">Add</button>
            </div>
          </form>
        </div>

        <div class="card" style="margin-top:16px">
          <h3 style="margin-top:0;margin-bottom:8px">Add Category</h3>
          <div style="display:flex;gap:8px">
            <input id="catNameInput" type="text" placeholder="Category name" />
            <button id="addCatBtn" class="button" type="button">Add Category</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <nav class="bottom-nav" aria-label="Primary">
    <div class="nav-inner" role="tablist">
      <button class="nav-btn active" id="tab-list" data-target="screen-list" title="List" aria-pressed="true">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><rect x="3" y="5" width="18" height="3" rx="1.2"/><rect x="3" y="10.5" width="18" height="3" rx="1.2"/><rect x="3" y="16" width="18" height="3" rx="1.2"/></svg>
        <span>List</span>
      </button>

      <button class="nav-btn" id="tab-budget" data-target="screen-budget" title="Budget" aria-pressed="false">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M3 7h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z" /><circle cx="17.5" cy="12.5" r="1.5" /></svg>
        <span>Budget</span>
      </button>

      <button class="nav-btn" id="tab-add" data-target="screen-add" title="Add" aria-pressed="false">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M12 5v14M5 12h14" /></svg>
        <span>Add</span>
      </button>
    </div>
  </nav>

<script>
  // Storage keys
  const STORAGE_ITEMS = 'list_app_items_v1';
  const STORAGE_CATS = 'list_app_cats_v1';
  const STORAGE_BUDGET = 'list_app_budget_v1';
  const STORAGE_SHOW_IMAGES = 'list_app_show_images_v1';

  // Elements
  const tabs = document.querySelectorAll('.nav-btn');
  const screens = document.querySelectorAll('.screen');
  const headerBudgetEl = document.getElementById('headerBudget');
  const showImagesToggle = document.getElementById('showImagesToggle');
  const deleteModeToggle = document.getElementById('deleteModeToggle');
  const deleteBar = document.getElementById('deleteBar');
  const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');

  const categoryContainer = document.getElementById('categoryContainer');
  const uncatItemsEl = document.getElementById('uncatItems');
  const itemsSummary = document.getElementById('itemsSummary');
  const totalSpentEl = document.getElementById('totalSpent');
  const emptyMsg = document.getElementById('emptyMsg');

  const catNameInput = document.getElementById('catNameInput');
  const addCatBtn = document.getElementById('addCatBtn');

  const nameInput = document.getElementById('nameInput');
  const priceInput = document.getElementById('priceInput');
  const itemSpent = document.getElementById('itemSpent');
  const notesInput = document.getElementById('notesInput');
  const imageInput = document.getElementById('imageInput');
  const linkInput = document.getElementById('linkInput');
  const categorySelect = document.getElementById('categorySelect');
  const addBtn = document.getElementById('addBtn');

  const budgetInput = document.getElementById('budgetInput');
  const saveBudgetBtn = document.getElementById('saveBudgetBtn');

  // App state
  let items = []; // {id,name,price,spent,notes,image,link,bought,catId,addedAt}
  let categories = []; // {id,name,collapsed,items: [ids]}
  let budgetValue = 0;
  let showImages = true;
  let deleteMode = false;
  let deleteSelections = new Set();

  // utils
  function uid(){ return Math.random().toString(36).slice(2,9); }
  function formatMoney(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

  // load/save
  function load(){
    try{ items = JSON.parse(localStorage.getItem(STORAGE_ITEMS)) || []; }catch(e){ items = []; }
    try{ categories = JSON.parse(localStorage.getItem(STORAGE_CATS)) || []; }catch(e){ categories = []; }
    try{ budgetValue = Number(localStorage.getItem(STORAGE_BUDGET)) || 0; }catch(e){ budgetValue = 0; }
    try{ showImages = localStorage.getItem(STORAGE_SHOW_IMAGES) === null ? true : (localStorage.getItem(STORAGE_SHOW_IMAGES) === '1'); }catch(e){ showImages = true; }
    budgetInput.value = budgetValue ? budgetValue : '';
    showImagesToggle.checked = showImages;
    updateHeaderBudget();
    populateCategorySelect();
    renderAll();
  }
  function saveItems(){ localStorage.setItem(STORAGE_ITEMS, JSON.stringify(items)); }
  function saveCats(){ localStorage.setItem(STORAGE_CATS, JSON.stringify(categories)); }
  function saveBudget(){ localStorage.setItem(STORAGE_BUDGET, String(budgetValue)); }
  function saveShowImages(){ localStorage.setItem(STORAGE_SHOW_IMAGES, showImages ? '1' : '0'); }

  // header budget
  function updateHeaderBudget(){ headerBudgetEl.textContent = 'Budget: £' + formatMoney(budgetValue); }

  // category select population
  function populateCategorySelect(){
    categorySelect.innerHTML = '<option value=\"\">Uncategorized</option>';
    categories.forEach(c=> {
      const opt = document.createElement('option'); opt.value = c.id; opt.text = c.name; categorySelect.appendChild(opt);
    });
  }

  // rendering
  function renderAll(){
    renderCategories();
    renderUncategorized();
    renderSummary();
    updateDeleteSelectedBtn();
  }

  function renderCategories(){
    categoryContainer.innerHTML = '';
    if(categories.length === 0){
      categoryContainer.innerHTML = '<div class=\"muted\">No categories. Add one in the Add tab.</div>';
      return;
    }
    categories.forEach(cat => {
      const catDiv = document.createElement('div'); catDiv.className = 'category'; if(cat.collapsed) catDiv.classList.add('collapsed');
      const header = document.createElement('div'); header.className = 'category-header';
      const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center';
      const arrow = document.createElement('span'); arrow.className='cat-arrow'; arrow.textContent = cat.collapsed ? '▸' : '▾';
      const title = document.createElement('span'); title.textContent = cat.name; title.style.marginLeft='8px';
      left.appendChild(arrow); left.appendChild(title);
      header.appendChild(left);
      const right = document.createElement('div');
      const delBtn = document.createElement('button'); delBtn.className='button'; delBtn.style.background='var(--danger)'; delBtn.style.padding='6px 10px'; delBtn.textContent='Delete';
      delBtn.addEventListener('click', (e)=>{ e.stopPropagation(); if(!confirm('Delete category and all items in it?')) return; // delete items in this category
        const catItemIds = new Set(cat.items);
        items = items.filter(it => !catItemIds.has(it.id));
        categories = categories.filter(c=> c.id !== cat.id);
        saveItems(); saveCats(); populateCategorySelect(); renderAll();
      });
      right.appendChild(delBtn);
      header.appendChild(right);

      // toggle collapse on header click
      header.addEventListener('click', ()=>{
        cat.collapsed = !cat.collapsed; saveCats(); renderCategories();
      });

      catDiv.appendChild(header);

      const list = document.createElement('div'); list.className='category-items';
      list.style.display = cat.collapsed ? 'none' : 'grid';

      // drop target
      list.addEventListener('dragover', e => e.preventDefault());
      list.addEventListener('drop', e => {
        e.preventDefault();
        const id = e.dataTransfer.getData('text/plain');
        const item = items.find(it => it.id === id);
        if(!item) return;
        // remove from old category list if present
        categories.forEach(c=> c.items = c.items.filter(i => i !== id));
        // add to this category
        cat.items.push(id);
        item.catId = cat.id;
        saveItems(); saveCats(); renderAll();
      });

      // render items that belong to cat (in insertion order)
      cat.items.forEach(id => {
        const it = items.find(x => x.id === id);
        if(!it) return; // skip if missing
        const row = renderItemRow(it);
        list.appendChild(row);
      });

      catDiv.appendChild(list);
      categoryContainer.appendChild(catDiv);
    });
  }

  function renderUncategorized(){
    uncatItemsEl.innerHTML = '';
    const uncat = items.filter(i => !i.catId);
    if(uncat.length === 0){
      // show nothing
    } else {
      uncat.forEach(it => {
        const row = renderItemRow(it);
        // allow dropping here
        row.addEventListener('dragover', e => e.preventDefault());
        uncatItemsEl.appendChild(row);
      });
    }
  }

  function renderItemRow(it){
    const row = document.createElement('div'); row.className = 'item'; row.draggable = true;
    // dragstart -> item id
    row.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', it.id); });

    // left: either delete selection checkbox or bought toggle
    const leftArea = document.createElement('div'); leftArea.style.display='flex'; leftArea.style.gap='12px'; leftArea.style.alignItems='center';

    if(deleteMode){
      const sel = document.createElement('input'); sel.type='checkbox'; sel.className='delCheck'; sel.value = it.id;
      sel.checked = deleteSelections.has(it.id);
      sel.addEventListener('change', e => {
        if(e.target.checked) deleteSelections.add(it.id); else deleteSelections.delete(it.id);
        updateDeleteSelectedBtn();
      });
      leftArea.appendChild(sel);
    } else {
      const cb = document.createElement('button');
      cb.className = 'checkbox' + (it.bought ? ' checked' : '');
      cb.title = it.bought ? 'Mark as not bought' : 'Mark as bought';
      cb.addEventListener('click', ()=>{
        it.bought = !it.bought; saveItems(); renderAll();
      });
      cb.innerHTML = it.bought ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#111827" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>' : '';
      leftArea.appendChild(cb);
    }
    // if images and available
    if(showImages && it.image){
      const thumb = document.createElement('div'); thumb.className='thumb'; const img = document.createElement('img'); img.src = it.image; img.alt = it.name || 'img'; thumb.appendChild(img);
      row.appendChild(thumb);
    }

    const body = document.createElement('div'); body.className='item-body';
    const title = document.createElement('div'); title.className='item-title'; title.textContent = it.name;
    const meta = document.createElement('div'); meta.className='item-meta';
    meta.textContent = [`£${formatMoney(it.price)}`, it.spent ? `Spent: £${formatMoney(it.spent)}` : ''].filter(Boolean).join(' • ');
    body.appendChild(title); body.appendChild(meta);
    if(it.notes){
      const notes = document.createElement('div'); notes.className='item-meta muted'; notes.style.marginTop='6px'; notes.textContent = it.notes; body.appendChild(notes);
    }
    if(it.link){
      const a = document.createElement('a'); a.className='link-badge'; a.href = it.link; a.target = '_blank'; a.rel='noopener noreferrer';
      a.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 14a3 3 0 0 1 0-4l4-4a3 3 0 0 1 4 4l-1 1"/></svg><span style="margin-left:6px">Open Link</span>';
      body.appendChild(a);
    }

    // assemble
    const leftWrapper = document.createElement('div');
    leftWrapper.style.display='flex'; leftWrapper.style.gap='12px'; leftWrapper.style.alignItems='flex-start';
    leftWrapper.appendChild(leftArea); leftWrapper.appendChild(body);
    row.appendChild(leftWrapper);

    const right = document.createElement('div'); right.className='item-right';
    if(!deleteMode){
      const del = document.createElement('button'); del.className='icon-btn delete-btn'; del.title='Delete';
      del.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="'+getComputedStyle(document.documentElement).getPropertyValue('--danger').trim()+'" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path></svg>';
      del.addEventListener('click', ()=>{
        if(!confirm('Delete this item?')) return;
        items = items.filter(x => x.id !== it.id);
        // remove from any category arrays
        categories.forEach(c => c.items = c.items.filter(id => id !== it.id));
        saveItems(); saveCats(); renderAll();
      });
      right.appendChild(del);
    }
    row.appendChild(right);
    return row;
  }

  function renderSummary(){
    itemsSummary.textContent = `${items.length} item${items.length===1?'':'s'} • ${items.filter(i=>i.bought).length} bought`;
    const total = items.reduce((s,i)=> s + Number(i.spent||0), 0);
    totalSpentEl.textContent = formatMoney(total);
    emptyMsg.style.display = items.length === 0 ? 'block' : 'none';
  }

  // Delete selected controls
  function updateDeleteSelectedBtn(){
    deleteSelectedBtn.disabled = deleteSelections.size === 0;
  }
  deleteSelectedBtn.addEventListener('click', ()=>{
    if(deleteSelections.size === 0) return;
    if(!confirm(`Delete ${deleteSelections.size} selected item${deleteSelections.size===1?'':'s'}?`)) return;
    items = items.filter(it => !deleteSelections.has(it.id));
    categories.forEach(c => c.items = c.items.filter(id => !deleteSelections.has(id)));
    saveItems(); saveCats();
    deleteSelections.clear(); deleteMode = false; deleteModeToggle.checked = false; deleteBar.style.display = 'none';
    updateDeleteSelectedBtn(); renderAll();
  });

  // add category
  document.getElementById('addCatBtn').addEventListener('click', ()=>{
    const name = catNameInput.value.trim();
    if(!name) return alert('Category name required');
    const id = uid();
    categories.push({id,name,collapsed:false,items:[]});
    saveCats(); catNameInput.value=''; populateCategorySelect(); renderAll();
  });

  // add item
  addBtn.addEventListener('click', ()=>{
    const name = nameInput.value.trim();
    if(!name) return alert('Name required');
    const price = Number(priceInput.value) || 0;
    const spent = Number(itemSpent.value) || 0;
    const notes = notesInput.value.trim();
    const link = linkInput.value.trim();
    const catId = categorySelect.value || null;
    const file = imageInput.files && imageInput.files[0];
    const push = (dataUrl)=>{
      const id = uid();
      items.push({id,name,price,spent,notes,link,image:dataUrl || null,bought:false,catId,addedAt:Date.now()});
      if(catId){
        const cat = categories.find(c=>c.id===catId);
        if(cat) cat.items.push(id);
      }
      saveItems(); saveCats(); populateCategorySelect(); renderAll();
      document.getElementById('addForm').reset();
      nameInput.focus();
      activateTab(document.getElementById('tab-list'));
    };
    if(file){
      const r = new FileReader();
      r.onload = e => push(e.target.result);
      r.readAsDataURL(file);
    } else push(null);
  });

  // drag-to-uncategorized support (uncat drop)
  const uncatEl = document.getElementById('uncatItems');
  uncatEl.addEventListener('dragover', e=> e.preventDefault());
  uncatEl.addEventListener('drop', e=>{
    e.preventDefault();
    const id = e.dataTransfer.getData('text/plain');
    const item = items.find(it=> it.id===id);
    if(!item) return;
    // remove from all categories
    categories.forEach(c => c.items = c.items.filter(i => i !== id));
    item.catId = null;
    saveItems(); saveCats(); renderAll();
  });

  // budget saving
  saveBudgetBtn.addEventListener('click', ()=>{
    budgetValue = Number(budgetInput.value) || 0;
    saveBudget(); updateHeaderBudget(); alert('Budget saved.');
  });

  // toggles
  showImagesToggle.addEventListener('change', ()=>{
    showImages = !!showImagesToggle.checked; saveShowImages(); renderAll();
  });

  deleteModeToggle.addEventListener('change', ()=>{
    deleteMode = !!deleteModeToggle.checked;
    // clear previous selections
    deleteSelections.clear();
    updateDeleteSelectedBtn();
    deleteBar.style.display = deleteMode ? '' : 'none';
    renderAll();
    if(!deleteMode) deleteSelectedBtn.disabled = true;
  });

  // tabs
  tabs.forEach(t => {
    t.addEventListener('click', ()=> activateTab(t));
  });
  function activateTab(btn){
    tabs.forEach(t => { t.classList.toggle('active', t===btn); t.setAttribute('aria-pressed', String(t===btn)); });
    const target = btn.dataset.target;
    screens.forEach(s => s.style.display = s.id === target ? '' : 'none');
    if(target === 'screen-list') renderAll();
  }

  // persistence helpers
  function saveItems(){ localStorage.setItem(STORAGE_ITEMS, JSON.stringify(items)); }
  function saveCats(){ localStorage.setItem(STORAGE_CATS, JSON.stringify(categories)); }
  function saveBudget(){ localStorage.setItem(STORAGE_BUDGET, String(budgetValue)); }
  function saveShowImages(){ localStorage.setItem(STORAGE_SHOW_IMAGES, showImages ? '1' : '0'); }

  // populate category select (for Add)
  function populateCategorySelect(){
    categorySelect.innerHTML = '<option value=\"\">Uncategorized</option>';
    categories.forEach(c => {
      const opt = document.createElement('option'); opt.value = c.id; opt.text = c.name; categorySelect.appendChild(opt);
    });
  }

  // initial load
  load();

  // load function (defined last to use helpers)
  function load(){
    try{ items = JSON.parse(localStorage.getItem(STORAGE_ITEMS)) || []; }catch(e){ items = []; }
    try{ categories = JSON.parse(localStorage.getItem(STORAGE_CATS)) || []; }catch(e){ categories = []; }
    try{ budgetValue = Number(localStorage.getItem(STORAGE_BUDGET)) || 0; }catch(e){ budgetValue = 0; }
    try{ showImages = localStorage.getItem(STORAGE_SHOW_IMAGES) === null ? true : (localStorage.getItem(STORAGE_SHOW_IMAGES) === '1'); }catch(e){ showImages = true; }

    budgetInput.value = budgetValue ? budgetValue : '';
    showImagesToggle.checked = showImages;
    deleteModeToggle.checked = deleteMode;
    populateCategorySelect();
    updateHeaderBudget();
    renderAll();
  }
</script>
</body>
</html>
